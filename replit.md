# Kraken Trading Bot - Self-Learning AI Edition

## Overview
An intelligent, self-learning cryptocurrency trading bot for the Kraken exchange. This project aims to provide autonomous trading capabilities, continuous improvement through self-learning, and a conversational AI interface for user interaction and insights. The bot offers risk management, bracket orders, and a daily loss kill-switch, with the ambition to monitor markets 24/7 and handle the entire trading workload.

## User Preferences
- User prefers to be called: jimmy
- Zyn's role: Financial servant who does ALL the work FOR jimmy
- Zyn handles the entire trading workload autonomously so jimmy doesn't have to

## System Architecture

### UI/UX Decisions
- Chat interface on port 5000 for real-time interaction.
- Dashboard for displaying accurate trading status, open positions, balances, and P&L, driven directly by Kraken data.

### Technical Implementations
- **Account State (`account_state.py`)**: **NEW (Nov 13, 2025)**: Canonical mode-aware account data provider ensuring COMPLETE LIVE/PAPER isolation. **CRITICAL BUGFIX**: User reported bot claiming trades that don't exist - root cause was PAPER mode fetching real Kraken account history. Solution: PaperLedger class with JSON persistence (`paper_ledger.json`) provides isolated paper trading state. **Three core functions**: (1) `get_balances()` returns Kraken API data in LIVE mode, paper ledger in PAPER mode, (2) `get_trade_history()` returns mode-appropriate trade history with ZERO cross-contamination, (3) `get_portfolio_snapshot()` provides complete portfolio view from correct source. **Architecture**: Single source of truth per mode - PAPER uses paper_ledger.json, LIVE uses Kraken API, NEVER mixed. **Integration**: Integrated with `paper_trading.py` simulator to record simulated fills, slippage, and fees to paper ledger. System guarantees complete truthfulness: if paper ledger is empty, status shows zero trades (no hallucinations).
- **Status Service (`status_service.py`)**: A centralized module serving as the single source of truth for all trading data (modes, balances, orders, trades, activity summaries). **CRITICAL FIXES (Nov 13, 2025)**: (1) **Mode isolation enforcement**: `sync_exchange()` now SKIPS open/closed order fetching in PAPER mode (only runs `if mode == "live"`), (2) `_get_cached_trades()` routes to `account_state.get_trade_history()` in PAPER mode instead of calling Kraken API, (3) All balance/trade queries use `account_state` functions for guaranteed mode awareness. **Previous issues**: Nov 12-13 fixes included fetching trade history DIRECTLY from Kraken API with 60-second caching and auto-sync every 60 seconds for balances/orders. Dashboard now shows 100% accurate data from correct source (Kraken for LIVE, paper ledger for PAPER). **Architect verified**: PASS rating for complete LIVE/PAPER isolation - no cross-mode contamination possible.
- **Self-Learning Components**:
    - **Telemetry Database (`telemetry_db.py`)**: An SQLite database (`trading_memory.db`) storing all trades, decisions, performance, insights, errors, and conversations for persistent learning.
    - **Trade Analyzer (`trade_analyzer.py`)**: An intelligence engine that calculates win rates, profit factors, and identifies successful strategies and market patterns.
    - **Time Context (`time_context.py`)**: Provides temporal intelligence, including current date/time awareness, market hours, and time-based feature extraction for pattern recognition.
    - **LLM Agent (`llm_agent.py`)**: Integrates OpenAI GPT-4o with function calling for command execution. **NATURAL LANGUAGE COMMAND PARSING (Nov 13, 2025)**: Implemented automated helper for percentage-based bracket orders to eliminate "Load failed" errors. (1) New function `execute_bracket_with_percentages()` automatically fetches market price, calculates absolute SL/TP from percentages, and uses symbol-specific precision (via ccxt price_to_precision/amount_to_precision) to prevent rounding errors on low-priced assets, (2) Enhanced command validation detects parse failures and returns structured error messages with required syntax instead of vague "Load failed", (3) Debug logging at 3 checkpoints (ATTEMPT, PARSE-FAIL, COMMAND-OK) for troubleshooting. **User experience**: User can now say "Paper buy 0.03 ZEC/USD with 1% SL and 2% TP" and bot automatically handles price fetching and calculation, or if LLM uses wrong format, receives clear guidance on correct syntax. **ANTI-HALLUCINATION UPGRADE (Nov 13, 2025)**: Added STRICT safeguards to prevent bot from claiming trades that don't exist. (1) Full status command now uses `account_state` directly (bypasses any caching issues), (2) System prompt has **8 CRITICAL RULES** for trade reporting: NEVER claim trades unless they appear in TRADING_STATUS, NEVER report from memory, ALWAYS check recent_trades array before claiming ANY trades, (3) If recent_trades is EMPTY, bot MUST say "No trades in account history", (4) Added explicit instruction: "If paper ledger is empty, you have ZERO trades - do not invent examples". **Previous capabilities**: (1) learn from trading history, (2) provide time-aware responses, (3) explain decisions, (4) support natural language conversation with memory, (5) execute trading commands via natural language, (6) fetch real-time market prices from Kraken API, (7) get market info for any symbol, (8) maintain conversation context with 20-turn memory. **Result**: Complete truthfulness in all user-facing communications - bot only reports data from authoritative sources.
    - **Evaluation Log / Transparency Layer (`evaluation_log.py`)**: **NEW (Nov 13, 2025)**: Complete debugging and transparency system providing full visibility into every trading evaluation. SQLite database (`evaluation_log.db`) captures: (1) timestamped evaluation decisions with symbol, price, and candle timestamp, (2) all indicator values (RSI, ATR, volume percentile, ADX, BB position, SMA20/50), (3) market regime classification, (4) decision type (BUY/SELL_ALL/HOLD/LONG/SKIP/ERROR) with detailed reason, (5) position snapshot and error messages, (6) heartbeat monitoring for 5-minute scheduler verification. **Provides four LLM-callable debug tools**: `show_last_evaluations()` (recent decision history with indicators), `show_today_summary()` (decision counts and NO_TRADE reason breakdown), `explain_why_no_trades_today()` (data-backed explanation generator), `check_heartbeat()` (scheduler health verification with staleness detection). User can now ask "why no trades today?" and receive concrete, indicator-backed answers instead of vague responses. System guarantees complete truthfulness: never logs until evaluation completes, never silently fails.
- **Trading Components**:
    - **Autopilot (`autopilot.py`)**: The autonomous trading loop that logs all decisions, executed trades, and performance. **CRITICAL UPDATE (Nov 13, 2025)**: Refactored to use **5-minute closed-candle strategy** for Kraken API compliance. Now fetches OHLC candles once per 5-minute interval, evaluates SMA20 crossover signals ONLY when a new candle closes (no mid-candle evaluations), and maintains per-symbol candle tracking in state.json. **RISK INTEGRATION (Nov 13, 2025)**: Three mandatory risk gatekeepers now enforce limits before every trade: (1) Daily trade limits via `can_open_new_trade()` (max 10/symbol, 30/day global), (2) Per-trade risk validation via `calculate_trade_risk()` with ATR-based SL estimation, (3) Portfolio-wide risk check via `get_max_active_risk()` (2% max active risk, enforcement deferred pending SL tracking). All trades recorded to telemetry via `record_trade_opened()` for lifecycle tracking. Loop runs every 300 seconds (5 minutes), staying 99% under Kraken's API rate limits.
    - **Trading Config (`trading_config.py`)**: **AGGRESSIVE TUNING (Nov 13, 2025)**: Centralized configuration system with dataclass architecture. **Thresholds lowered for more trading opportunities**: (1) ADX trending threshold reduced from 25 to 18 (detects trends earlier), (2) Min volatility lowered from 0.08% to 0.05% (trades quieter markets), (3) Min ADX lowered from 10 to 8 (less restrictive NO_TRADE regime), (4) BB width increased from 4% to 5% (wider range classification). Provides: IndicatorConfig for SMA/RSI/ATR settings, MarketFilters for volatility/volume/chop thresholds, RiskConfig for position sizing and limits, RegimeConfig for market classification. Environment variable overrides supported for all parameters.
    - **Signal Engine (`signal_engine.py`)**: **NEW (Nov 13, 2025)**: Professional multi-signal decision engine with sequential hard filters. Orchestrates RSI, SMA trend, volume, volatility, chop detection, and ATR spike filters. Returns detailed SignalResult with action ('long'/'short'/'hold'), reason, passed filters, and failed filter diagnostics. All filters must pass for trade signal generation.
    - **Strategy Orchestrator (`strategy_orchestrator.py`)**: **AGGRESSIVE RANGE TRADING (Nov 13, 2025)**: Regime-aware strategy selector that routes trades based on market regime (TREND_UP, TREND_DOWN, RANGE, BREAKOUT_EXPANSION, NO_TRADE). **Range strategy enhanced**: Now enters trades when price is in lower 40% of Bollinger Bands (not just at exact lower band), with RSI threshold relaxed from 35 to 45. Added mid-band momentum entries (40-60% band position) with HTF bullish confirmation. Confidence scaling based on proximity to band edges (0.45-0.85).
    - **Candle Strategy (`candle_strategy.py`)**: Pure indicator calculation module for closed-candle analysis. **ENHANCED (Nov 13, 2025)**: Now includes: (1) `calculate_rsi()` for momentum filtering, (2) `is_volume_acceptable()` for percentile-based volume filtering, (3) `is_choppy_market()` for sideways detection via SMA slope and price range, (4) `is_volatility_acceptable()` for ATR/price ratio checks, (5) `detect_atr_spike()` for market shock detection, (6) `check_trend_strength()` for SMA20/SMA50 alignment. All functions are deterministic and work only with historical closed candles.
    - **Paper Trading (`paper_trading.py`)**: **NEW (Nov 13, 2025)**: Complete simulation system with realistic fills, slippage (5 bps bid-ask spread), trading fees (0.16% maker, 0.26% taker), bracket order management, position tracking, P&L calculation, and performance statistics. State persisted to JSON for continuity across restarts.
    - **Exchange Manager (`exchange_manager.py`)**: Singleton exchange wrapper with `fetch_ohlc()` method for retrieving 5-minute candle data from Kraken. Validates timeframe/limit parameters and enforces paper/live mode consistency across all modules.
    - **Risk Manager (`risk_manager.py`)**: **NEW (Nov 13, 2025)**: Professional risk management module with PositionSnapshot protocol. Provides: (1) `calculate_trade_risk()` for per-trade stop-loss risk calculation with ValueError on invalid SL placement, (2) `get_max_active_risk()` for portfolio-wide risk aggregation across all open positions. Works with both paper and live trading modes.
    - **Trading Limits (`trading_limits.py`)**: **NEW (Nov 13, 2025)**: Daily trade limit enforcement system with JSON state persistence. Provides: (1) `can_open_new_trade()` for pre-trade limit checks (max 10 trades/symbol, 30 total), (2) `record_trade_opened()` for post-execution tracking, (3) `get_daily_stats()` for limit monitoring. Counter resets at midnight UTC, shared across paper/live modes to prevent limit bypassing.
    - **Commands (`commands.py`)**: Handles manual trading commands for order placement and management.
    - **Run (`run.py`)**: Provides an interactive shell for direct command execution.
- **Advanced Modules (Feature-flagged)**:
    - `crypto_universe.py`: Support for 200+ Kraken pairs with liquidity filtering.
    - `profit_target.py`: Daily profit targeting and session management.
    - `multi_timeframe.py`: Multi-timeframe confirmation (1h/4h/1d).
    - `api_watchdog.py`: Self-healing with circuit breaker and auto-restart.
    - `backtest_mode.py`: Historical backtesting without live orders.

### Feature Specifications
- **Conversational AI**: Users can chat with the bot to inquire about performance, trading decisions, market insights, and manage preferences. Supports power commands for status, learning, memory, and command execution.
- **Autonomous Trading**: The bot executes trades based on learned patterns and predefined strategies (e.g., SMA20), with automated position sizing, bracket orders (take-profit + stop-loss), and risk management.
- **Continuous Learning**: The bot analyzes trade outcomes, market patterns (e.g., time of day, day of week correlations), and strategy performance to improve its decision-making over time.
- **Risk Management**: Features include configurable risk per trade, maximum position size, daily loss kill-switch, ATR-based stop-loss and take-profit levels, and cool-off periods.
- **Safety Features**: Includes validation mode, pre-trade minimum volume checks, auto-adjustment of position sizes, emergency flatten procedures with retry logic, and comprehensive telemetry logging for safety events.
- **SMS Notifications**: Integration for trade execution alerts, daily P&L summaries, and weekly performance reports.

## External Dependencies
- **Kraken API**: For real-time market data, order placement, and account management.
- **ccxt**: Python library for interacting with cryptocurrency exchanges.
- **loguru**: For enhanced logging capabilities.
- **tenacity**: For robust retry logic in API calls.
- **python-dotenv**: For managing environment variables and secrets.
- **OpenAI API**: For the LLM agent (GPT-4o integration).